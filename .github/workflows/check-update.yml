name: Verificar Atualiza√ß√£o da Branch

on:
  pull_request:
    types:
      - labeled
  schedule:
    - cron: '0 * * * *' # Executar a cada hora

jobs:
  update-branch:
    if: ${{ contains(github.event.pull_request.labels.*.name, 'autoupdate') }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout da Branch
        uses: actions/checkout@v3

      - name: Setup git user to "ü§ñ github-actions bot"
        shell: bash
        run: git config user.email "<>" && git config user.name "ü§ñ github-actions[bot]"

      - name: Update branch
        run: |
          echo "Pull request head √©√©√©: {{ toJSON(github.event.pull_request.head) }}"
          git fetch origin
          echo "one -----------------"
          git checkout ${{ github.event.pull_request.head.ref }}
          echo "two -----------------"

          git config pull.rebase false

          echo "two2 -----------------"

          git pull origin main

          # Verificar se h√° conflitos durante o pull
          if git diff --name-only --diff-filter=U | grep -q .; then
            echo "Conflitos detectados durante o pull. Resolva manualmente e fa√ßa o commit."
            exit 1
          fi

          echo "three -----------------"
          git push origin ${{ github.event.pull_request.head.ref }}
          echo "four -----------------"

  remove-label:
    needs: [update-branch]
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Remove autoupdate label
        run: |
          # Remove o label de autoupdate
          # https://docs.github.com/en/rest/issues/labels?apiVersion=2022-11-28
          curl -L -X DELETE \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GH_API_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/labels/autoupdate

      - name: Output information
        run: |
          echo "Something went wrong"
          echo "${{ toJSON(github) }}"
